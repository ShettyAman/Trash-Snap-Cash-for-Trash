<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trash Snap - Smart Waste Detection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Removed Import Map to prevent conflict with direct URL import -->
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    
    <style>
        /* --- DASHBOARD THEME --- */
        body {
            background-color: #0f172a; /* Dark Slate / Navy Background */
            color: #e2e8f0; /* Light Gray Text */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Panel Styling */
        .dashboard-panel {
            background-color: #1e293b; 
            border: 1px solid #059669; 
            border-radius: 0.5rem;
            padding: 0.75rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .panel-header {
            font-size: 0.9rem;
            font-weight: bold;
            color: #34d399; 
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #334155;
            padding-bottom: 0.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        /* Input Styling */
        input[type="file"] {
            background-color: #0f172a;
            color: #94a3b8;
            border: 1px dashed #34d399;
            padding: 0.4rem;
            font-size: 0.8rem;
            border-radius: 0.25rem;
            width: 100%;
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid #1e293b;
            border-top: 3px solid #34d399;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Map Fix */
        #map {
            width: 100%;
            height: 100%;
            min-height: 100%;
            border-radius: 0.25rem;
            z-index: 1; 
        }

        /* --- GALLERY & BOXES --- */
        .gallery-container {
            overflow-y: auto;
            flex-grow: 1;
            padding-right: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-content: flex-start;
        }

        .gallery-item {
            position: relative;
            border: 1px solid #334155;
            border-radius: 0.25rem;
            background-color: #020617;
            transition: all 0.3s ease;
            display: flex; 
            flex-direction: column;
            width: fit-content; 
            height: fit-content; 
        }

        .gallery-item.thumbnail {
            height: 120px; 
            cursor: zoom-in;
            opacity: 1;
        }
        
        .gallery-item.thumbnail img {
            height: 120px; 
            width: auto;   
            display: block; 
        }
        .gallery-item.thumbnail .bounding-box { display: none !important; }

        .gallery-item.dimmed {
            opacity: 0.3;
            filter: grayscale(80%);
        }

        /* Expanded State */
        .gallery-item.expanded {
            position: fixed; 
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            max-width: 85vw; 
            max-height: 85vh;
            width: auto !important;
            height: auto !important;
            border: 2px solid #34d399;
            box-shadow: 0 0 100px rgba(0,0,0,0.9);
            background-color: #020617;
            cursor: zoom-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .gallery-item.expanded img {
            max-width: 100%;
            max-height: 85vh; 
            width: auto;
            height: auto;
            display: block;
            object-fit: contain; 
        }

        /* Image ID Tag */
        .img-tag {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background-color: rgba(0, 0, 0, 0.85); 
            color: #34d399; 
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            pointer-events: none;
            z-index: 25; 
            border: 1px solid #34d399;
        }

        /* Bounding Boxes */
        .bounding-box {
            position: absolute;
            border: 2px solid #6ee7b7; 
            background-color: rgba(110, 231, 183, 0.15); 
            z-index: 10;
            transition: all 0.2s;
            cursor: pointer;
        }
        .bounding-box-label {
            position: absolute;
            top: -18px;
            left: 0;
            background-color: #6ee7b7; 
            color: #0f172a; 
            font-size: 9px; 
            padding: 1px 3px;
            font-weight: bold;
            border-radius: 2px;
            white-space: nowrap;
        }

        /* Highlight Interaction */
        .bounding-box.highlight {
            border-color: #00ff00 !important; 
            background-color: rgba(0, 255, 0, 0.2) !important;
            z-index: 20;
            box-shadow: 0 0 10px #00ff00;
        }
        .bounding-box.highlight .bounding-box-label {
            background-color: #00ff00;
            color: black;
        }
        .faded-box { opacity: 0.1; }

        /* Feed Styles */
        .feed-group {
            margin-bottom: 0.5rem;
            border: 1px solid #334155;
            border-radius: 0.25rem;
            overflow: hidden;
        }
        .feed-header {
            background-color: #1e293b;
            padding: 0.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #e2e8f0;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .feed-header:hover { background-color: #334155; }
        .feed-content {
            display: none;
            background-color: #0f172a;
            padding: 0.25rem;
        }
        .feed-content.open { display: block; }
        .feed-item {
            padding: 0.4rem;
            margin: 0.25rem 0;
            border-left: 2px solid #34d399;
            background-color: #1e293b;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .feed-item:hover { background-color: #1e3a8a; padding-left: 0.6rem; }
        .dropdown-arrow { transition: transform 0.2s; font-size: 0.7rem; }
        .feed-content.open + .feed-header .dropdown-arrow, 
        .feed-group.active .dropdown-arrow { transform: rotate(180deg); }
        
        /* Map Tooltip Styles */
        .custom-tooltip {
            background: white !important;
            border: 2px solid #34d399 !important;
            color: #1e293b !important; 
            font-size: 0.8rem;
            border-radius: 6px;
            padding: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            min-width: 180px; 
            max-width: 220px;
        }
        .tooltip-stat-box {
            background-color: #dbeafe; 
            border: 1px solid #93c5fd;
            border-radius: 4px;
            padding: 3px; 
            text-align: center;
            color: #1e3a8a; 
            font-weight: bold;
            font-size: 0.65rem; 
            white-space: nowrap; 
        }
        
        /* Marketplace Styles */
        .price-category-group {
            border: 1px solid #334155;
            border-radius: 4px;
            margin-bottom: 10px;
            padding: 5px;
        }
        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px dashed #334155;
        }
        .price-row:last-child {
            border-bottom: none;
        }
        .best-price {
            background-color: #047857; 
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-slate-900 border-b border-green-800 p-3 flex justify-between items-center shadow-lg z-50 sticky top-0">
        <div class="flex items-center gap-2">
            <span class="text-xl">‚ôªÔ∏è</span>
            <h1 class="text-lg font-bold text-green-400 tracking-wider uppercase">TRASH SNAP <span class="text-[10px] text-gray-500 normal-case ml-2">Smart Waste Detection & Marketplace</span></h1>
        </div>
    </header>

    <!-- Main Dashboard Grid -->
    <main class="flex-grow p-3 grid grid-cols-1 md:grid-cols-12 gap-3">
        
        <!-- COLUMN 1: CONTROLS & RESULTS (Width: 4/12) -->
        <div class="md:col-span-4 flex flex-col gap-3">
            
            <div class="dashboard-panel">
                <div class="panel-header">
                    <span>1. System Controls</span>
                    <span class="text-[10px] bg-green-900 text-green-300 px-2 py-0.5 rounded">Input</span>
                </div>
                <div class="space-y-3">
                    <p class="text-xs text-gray-400">Select waste images for analysis.</p>
                    <input type="file" id="fileInput" accept="image/*" multiple />
                    <button onclick="identifyWaste()" class="w-full bg-green-700 hover:bg-green-600 text-white text-sm font-bold py-2 px-4 rounded transition flex justify-center items-center gap-2 shadow-lg shadow-green-900/50">
                        <span>INITIATE SCAN</span>
                        <div id="loadingSpinner" class="loader"></div>
                    </button>
                </div>
            </div>

            <div class="dashboard-panel flex-grow" style="height: 500px; min-height: 500px; max-height: 500px;">
                <div class="panel-header">
                    <span>Detected Objects Feed</span>
                    <span class="text-[10px] bg-blue-900 text-blue-300 px-2 py-0.5 rounded">Live Data</span>
                </div>
                <div id="aiResponse" class="overflow-y-auto pr-1 h-full text-xs space-y-2">
                    <div class="text-gray-500 italic text-center mt-10">
                        Waiting for input stream...<br>
                        Upload images to begin analysis.
                    </div>
                </div>
            </div>

        </div>

        <!-- COLUMN 2: VISUALS & MAP (Width: 8/12) -->
        <div class="md:col-span-8 flex flex-col gap-3">
            
            <div class="dashboard-panel" style="height: 450px; min-height: 450px;">
                <div class="panel-header">
                    <span>2. Visual Analysis Monitor</span>
                    <span class="text-[10px] text-gray-400">Click image to Expand/Minimize</span>
                </div>
                <div id="previewContainer" class="gallery-container">
                    <div class="text-gray-500 italic text-xs flex items-center justify-center h-full border border-dashed border-gray-700 rounded">
                        No Signal. Upload images to visualize.
                    </div>
                </div>
            </div>

            <div class="dashboard-panel" style="height: 350px; min-height: 350px;">
                <div class="panel-header">
                    <span>3. Geolocation Tracking</span>
                    <div class="flex gap-2 items-center">
                        <button onclick="locateUser()" class="text-[10px] bg-blue-900 text-blue-200 px-2 py-0.5 rounded hover:bg-blue-800 transition shadow">üìç Locate Me</button>
                    </div>
                </div>
                <div class="flex-grow relative rounded overflow-hidden">
                    <div id="map"></div>
                </div>
                <div id="shopList" class="hidden"></div>
            </div>
            
            <div class="dashboard-panel">
                <div class="panel-header">
                    <span>4. Marketplace Pricing & Contact</span>
                    <span class="text-[10px] bg-yellow-900 text-yellow-300 px-2 py-0.5 rounded">Rates (‚Çπ/kg)</span>
                </div>
                <div id="marketplaceComparison" class="overflow-y-auto text-xs space-y-3">
                    <div class="text-gray-500 italic text-center mt-5">
                        Scan waste to view current market prices and top buyers.
                    </div>
                </div>
            </div>

        </div>

    </main>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <!-- JS Logic -->
    <script type="module">
        // Use direct URL import for robustness
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        const GEMINI_API_KEY = "AIzaSyAas4Z4Y2Q-YyDV7uznMJq1NYPRhVNl7M0"; 
        
        let map;
        let markers = [];
        let userLocation = null; 
        let routeLine = null; 
        const BANGALORE_CENTER = [12.9716, 77.5946]; 
        const ROAD_FACTOR = 1.4; 

        // --- MARKET DATA ---
        const recyclingCenters = [
            { 
                name: "Scrapzone (Online)", lat: 12.9250, lng: 77.5938, address: "Jayanagar 4th T Block", chatUrl: "https://wa.me/919343221221",
                prices: { "paper": 14, "plastic": 22, "metal": 30, "e-waste": 50, "electronics": 10 }
            },
            { 
                name: "Zolopik E-Waste", lat: 13.0279, lng: 77.5933, address: "Hebbal", chatUrl: "https://wa.me/918884449985",
                prices: { "paper": 12, "plastic": 18, "metal": 35, "e-waste": 65, "battery": 75 }
            },
            { 
                name: "Cahoor Scrap (Shivajinagar)", lat: 12.9716, lng: 77.5946, address: "Shivajinagar", chatUrl: "https://wa.me/919845012345",
                prices: { "paper": 10, "plastic": 15, "metal": 45, "iron": 25 }
            },
            { 
                name: "BBMP DWCC (Koramangala)", lat: 12.9352, lng: 77.6245, address: "Koramangala", chatUrl: "https://wa.me/918022979200",
                prices: { "general": 0, "plastic": 10, "paper": 8 }
            }
        ];
        
        const categoryMap = {
            "plastic": "Plastic",
            "paper": "Paper & Cardboard",
            "cardboard": "Paper & Cardboard",
            "metal": "Metals (Ferrous/Non-Ferrous)",
            "iron": "Metals (Ferrous/Non-Ferrous)",
            "copper": "Metals (Ferrous/Non-Ferrous)",
            "e-waste": "E-Waste & Electronics",
            "electronics": "E-Waste & Electronics",
            "battery": "E-Waste & Electronics",
            "general": "General Recyclables" 
        };

        // --- CORE FUNCTIONS ---

        function processImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.naturalWidth;
                        canvas.height = img.naturalHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        
                        const dataUrl = canvas.toDataURL(file.type);
                        resolve({
                            base64: dataUrl.split(',')[1],
                            mime: file.type,
                            url: dataUrl
                        });
                    };
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // --- GLOBAL FUNCTIONS DEFINED EXPLICITLY FOR HTML ACCESS ---

        window.locateUser = function() {
            if (navigator.geolocation) {
                const mapEl = document.getElementById('map');
                mapEl.style.opacity = '0.5';
                
                navigator.geolocation.getCurrentPosition(position => {
                    mapEl.style.opacity = '1';
                    const { latitude, longitude } = position.coords;
                    userLocation = { lat: latitude, lng: longitude };
                    
                    if (map) {
                        map.setView([latitude, longitude], 14);
                        const userIcon = L.divIcon({
                            className: 'custom-div-icon',
                            html: "<div style='background-color:blue; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow: 0 0 5px blue;'></div>",
                            iconSize: [12, 12],
                            iconAnchor: [6, 6]
                        });
                        L.marker([latitude, longitude], {icon: userIcon}).addTo(map).bindPopup("You are here");
                    }
                }, (error) => {
                    mapEl.style.opacity = '1';
                    alert("GPS Error: " + error.message + "\n\nNote: For GPS to work, you must use HTTPS or run on 'localhost'. Opening a file directly (file://) blocks GPS.");
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        };

        // FIXED: Corrected function name in event handler assignment inside this function
        window.drawBoxes = function(imgId, items, globalStartIndex) {
            const wrapper = document.getElementById(`img-wrapper-${imgId}`);
            if(!wrapper) return;
            wrapper.querySelectorAll('.bounding-box').forEach(el => el.remove());

            items.forEach((item, idx) => {
                if (!item.box_2d) return;
                const [ymin, xmin, ymax, xmax] = item.box_2d;
                const uniqueId = `box-${imgId}-${idx}`; 

                const box = document.createElement('div');
                box.className = 'bounding-box';
                box.id = uniqueId; 
                
                box.style.top = `${(ymin/1000)*100}%`;
                box.style.left = `${(xmin/1000)*100}%`;
                box.style.height = `${((ymax-ymin)/1000)*100}%`;
                box.style.width = `${((xmax-xmin)/1000)*100}%`;

                const label = document.createElement('div');
                label.className = 'bounding-box-label';
                label.innerText = `${item.item}`;
                box.appendChild(label);

                // FIXED: Use window.resetHighlights instead of removeHighlight
                box.onmouseenter = () => window.highlightItem(uniqueId);
                box.onmouseleave = () => window.resetHighlights(uniqueId);

                wrapper.appendChild(box);
            });
        };

        window.identifyWaste = async function() {
            if (selectedImages.length === 0) {
                alert("System Alert: No images loaded.");
                return;
            }
            
            document.getElementById('loadingSpinner').style.display = 'inline-block';
            const responseDiv = document.getElementById('aiResponse');
            responseDiv.innerHTML = "<div class='text-green-400 animate-pulse font-mono text-xs'>[SYSTEM] Scanning Neural Network...</div>";

            const marketplaceDiv = document.getElementById('marketplaceComparison');
            marketplaceDiv.innerHTML = "<div class='text-green-400 animate-pulse font-mono text-xs text-center mt-5'>[SYSTEM] Fetching Price Data...</div>";


            const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
            const model = genAI.getGenerativeModel({ 
                model: "gemini-2.5-flash",
            });

            const prompt = `
                Analyze images. Detect recyclable items.
                CRITICAL INSTRUCTION: Group identical items!
                - If multiple similar items exist (e.g. pile of cups, stack of paper), draw ONE box around the group.
                - Name it collectively (e.g. "Stack of Cups").
                
                OUTPUT ONLY A JSON ARRAY. 
                Example: [{"item": "Name", "category": "plastic", "confidence": 90, "box_2d": [0,0,1000,1000]}]
                
                Fields:
                - "item": string
                - "category": one of ["plastic", "paper", "metal", "e-waste", "general"]
                - "confidence": number 0-100
                - "box_2d": [ymin, xmin, ymax, xmax] (normalized 0-1000)
            `;

            let allCategories = new Set();
            let itemsByImage = {}; 
            let globalItemIndex = 0; 

            try {
                for (const imgData of selectedImages) {
                    const result = await model.generateContent([
                        prompt, 
                        { inlineData: { data: imgData.base64, mimeType: imgData.mime } }
                    ]);
                    
                    let jsonText = result.response.text();
                    jsonText = jsonText.replace(/```json/g, '').replace(/```/g, '').trim();

                    let detectedItems = [];
                    try {
                        detectedItems = JSON.parse(jsonText);
                    } catch (parseError) {
                        console.error("JSON Parse Error. Raw text:", jsonText);
                        throw new Error("Failed to parse AI response. Try again.");
                    }
                    
                    itemsByImage[imgData.id] = detectedItems;

                    // Call global drawBoxes
                    window.drawBoxes(imgData.id, detectedItems, globalItemIndex);

                    detectedItems.forEach(obj => allCategories.add(obj.category.toLowerCase()));
                    globalItemIndex += detectedItems.length;
                }

                // Render Feed
                let feedHtml = "";
                Object.keys(itemsByImage).sort().forEach(imgIdKey => {
                    const imgId = parseInt(imgIdKey);
                    const items = itemsByImage[imgId];
                    const imgLabel = `IMG #${imgId + 1}`;
                    const groupId = `feed-img-${imgId}`;
                    const wrapperId = `img-wrapper-${imgId}`;

                    let itemsListHtml = "";
                    items.forEach((item, idx) => {
                        const uniqueBoxId = `box-${imgId}-${idx}`; 
                        itemsListHtml += `
                            <div class="feed-item"
                                 onmouseenter="highlightBoxOnImage('${uniqueBoxId}', '${wrapperId}')"
                                 onmouseleave="resetHighlights()">
                                <div class="flex justify-between items-center">
                                    <span class="font-bold text-gray-200">${item.item}</span>
                                    <span class="text-[10px] text-gray-500">${item.confidence}%</span>
                                </div>
                                <div class="text-[10px] text-green-400 uppercase tracking-wider">${item.category}</div>
                            </div>
                        `;
                    });

                    feedHtml += `
                        <div class="feed-group">
                            <div class="feed-header" 
                                 onclick="toggleFeedGroup('${groupId}')"
                                 onmouseenter="highlightGalleryImage('${wrapperId}')"
                                 onmouseleave="resetGalleryHighlights()">
                                <span>üì∑ ${imgLabel} <span class="text-gray-500 text-[10px]">(${items.length} items)</span></span>
                                <span class="dropdown-arrow">‚ñº</span>
                            </div>
                            <div id="${groupId}" class="feed-content">
                                ${itemsListHtml || "<div class='p-2 text-gray-500 italic'>No items found</div>"}
                            </div>
                        </div>
                    `;
                });

                responseDiv.innerHTML = feedHtml || "<div class='text-gray-500 text-xs'>No items detected.</div>";
                
                const uniqueCategories = Array.from(allCategories);
                filterMap(uniqueCategories);
                updateMarketplace(uniqueCategories);

            } catch (error) {
                console.error("Gemini API Full Error:", error);
                responseDiv.innerHTML = `<div class='text-red-500 text-xs'>Error: ${error.message}. <br>Try fewer images or clearer photos.</div>`;
                marketplaceDiv.innerHTML = "<div class='text-red-500 text-xs text-center mt-5'>Price fetch failed.</div>";

            } finally {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        };

        // --- MARKETPLACE LOGIC ---
        function updateMarketplace(categories) {
            const marketplaceDiv = document.getElementById('marketplaceComparison');
            marketplaceDiv.innerHTML = "";
            
            if (categories.length === 0) {
                 marketplaceDiv.innerHTML = "<div class='text-gray-500 italic text-center mt-5'>Scan waste to view current market prices and top buyers.</div>";
                 return;
            }

            let marketplaceHtml = "";
            let uniqueGroups = new Set();
            categories.forEach(cat => {
                const group = categoryMap[cat] || "Other Recyclables";
                uniqueGroups.add(group);
            });

            // Iterate through marketplace groups
            uniqueGroups.forEach(groupName => {
                let bestPrices = {}; // Store {companyName: price} for comparison

                // Collect prices from all centers for this group
                recyclingCenters.forEach(center => {
                    for (const [material, price] of Object.entries(center.prices)) {
                        const materialGroup = categoryMap[material] || "Other Recyclables";
                        if (materialGroup === groupName) {
                            if (!bestPrices[center.name] || price > bestPrices[center.name].price) {
                                bestPrices[center.name] = { price: price, material: material, chatUrl: center.chatUrl };
                            }
                        }
                    }
                });

                if (Object.keys(bestPrices).length === 0) return;

                // Find the absolute best price for this group
                let bestPrice = -1;
                Object.values(bestPrices).forEach(bp => {
                    if (bp.price > bestPrice) bestPrice = bp.price;
                });

                let groupHtml = `<div class="price-category-group">
                    <h5 class="text-green-300 font-bold mb-2">${groupName}</h5>
                    <div class="space-y-1">`;
                
                // Display prices per company
                Object.entries(bestPrices).forEach(([companyName, data]) => {
                    const isBest = data.price === bestPrice && data.price > 0;
                    
                    groupHtml += `
                        <div class="price-row text-xs">
                            <span class="text-gray-400">${companyName}</span>
                            <div class="flex items-center gap-2">
                                <span class="${isBest ? 'best-price' : 'text-gray-300'}">
                                    ‚Çπ ${data.price} / kg 
                                </span>
                                <button onclick="window.open('${data.chatUrl}', '_blank')" 
                                        class="bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 rounded text-[10px] shadow">
                                    Chat
                                </button>
                            </div>
                        </div>
                    `;
                });

                groupHtml += `</div></div>`;
                marketplaceHtml += groupHtml;
            });

            marketplaceDiv.innerHTML = marketplaceHtml || "<div class='text-gray-500 italic text-center mt-5'>No pricing data found for detected items.</div>";
        }


        // --- INTERACTION / UTILITIES ---

        window.toggleFeedGroup = function(id) {
            const el = document.getElementById(id);
            if (el) el.classList.toggle('open');
        };

        window.highlightGalleryImage = function(wrapperId) {
            document.querySelectorAll('.gallery-item').forEach(el => {
                if (el.id === wrapperId) {
                    el.style.opacity = '1';
                    el.style.filter = 'none';
                    el.style.borderColor = '#34d399';
                } else {
                    el.classList.add('dimmed');
                }
            });
        };

        window.resetGalleryHighlights = function() {
            document.querySelectorAll('.gallery-item').forEach(el => {
                el.classList.remove('dimmed');
                el.style.opacity = '1';
                el.style.filter = 'none';
                el.style.borderColor = '#334155';
            });
        };

        window.expandGalleryImage = function(wrapperId) {
            document.querySelectorAll('.gallery-item.expanded').forEach(el => {
                if(el.id !== wrapperId) {
                    el.classList.remove('expanded');
                    el.classList.add('thumbnail');
                }
            });
            const wrapper = document.getElementById(wrapperId);
            if (wrapper) {
                wrapper.classList.remove('thumbnail');
                wrapper.classList.add('expanded');
            }
        };

        window.highlightBoxOnImage = function(boxId, wrapperId) {
            expandGalleryImage(wrapperId);
            document.querySelectorAll('.bounding-box').forEach(b => b.classList.add('faded-box'));
            const box = document.getElementById(boxId);
            if (box) {
                box.classList.remove('faded-box');
                box.classList.add('highlight');
            }
        };

        window.highlightItem = function(boxId) {
             document.querySelectorAll('.bounding-box').forEach(b => b.classList.add('faded-box'));
             const box = document.getElementById(boxId);
             if(box) {
                 box.classList.remove('faded-box');
                 box.classList.add('highlight');
             }
        };

        window.resetHighlights = function() {
            document.querySelectorAll('.bounding-box').forEach(b => {
                b.classList.remove('faded-box');
                b.classList.remove('highlight');
            });
        };

        window.openGoogleMaps = function(destLat, destLng) {
            const url = `https://www.google.com/maps/dir/?api=1&destination=${destLat},${destLng}&travelmode=driving`;
            window.open(url, '_blank');
        };

        // --- IMAGE FILE HANDLING ---
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        let selectedImages = []; 

        fileInput.addEventListener('change', async function() {
            selectedImages = [];
            previewContainer.innerHTML = ""; 
            
            if (this.files.length > 0) {
                for (let i = 0; i < this.files.length; i++) {
                    const file = this.files[i];
                    if (file.size > 8 * 1024 * 1024) {
                        alert("File too large > 8MB"); continue;
                    }

                    const processedImg = await processImage(file);
                    const id = i;
                    
                    selectedImages.push({
                        id: id,
                        base64: processedImg.base64,
                        mime: processedImg.mime
                    });

                    const wrapper = document.createElement("div");
                    wrapper.className = "gallery-item thumbnail"; 
                    wrapper.id = `img-wrapper-${id}`;
                    
                    wrapper.onclick = function(e) {
                        if(e.target.classList.contains('bounding-box') || 
                           e.target.classList.contains('bounding-box-label')) return;
                        
                        if (this.classList.contains('expanded')) {
                            this.classList.remove('expanded');
                            this.classList.add('thumbnail');
                        } else {
                            document.querySelectorAll('.gallery-item.expanded').forEach(el => {
                                el.classList.remove('expanded');
                                el.classList.add('thumbnail');
                            });
                            this.classList.remove('thumbnail');
                            this.classList.add('expanded');
                        }
                    };

                    const img = document.createElement("img");
                    img.src = processedImg.url; 
                    img.id = `img-${id}`;
                    
                    const tag = document.createElement("div");
                    tag.className = "img-tag";
                    tag.innerText = `IMG #${id + 1}`;

                    wrapper.appendChild(img);
                    wrapper.appendChild(tag);
                    previewContainer.appendChild(wrapper);
                }
            }
        });

        // --- MAP LOGIC ---
        
        function initMap() {
            if (typeof L === 'undefined') {
                console.error("Leaflet not loaded");
                return;
            }
            map = L.map('map').setView(BANGALORE_CENTER, 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            filterMap([]);

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const { latitude, longitude } = position.coords;
                    userLocation = { lat: latitude, lng: longitude };
                    map.setView([latitude, longitude], 14);
                    const userIcon = L.divIcon({
                        className: 'custom-div-icon',
                        html: "<div style='background-color:blue; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow: 0 0 5px blue;'></div>",
                        iconSize: [12, 12],
                        iconAnchor: [6, 6]
                    });
                    L.marker([latitude, longitude], {icon: userIcon}).addTo(map).bindPopup("You are here");
                });
            }
        }

        if (document.readyState === 'complete') {
            initMap();
        } else {
            window.addEventListener('load', initMap);
        }
        
        function filterMap(activeCategories) {
            if(!map) return;
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            const listContainer = document.getElementById('shopList');
            if (listContainer) listContainer.innerHTML = "";

            const filtered = recyclingCenters.filter(center => {
                if (activeCategories.length === 0) return true;
                return activeCategories.some(cat => {
                    // Check if the center buys any material in the detected category
                    for (const boughtMaterial of Object.keys(center.prices)) {
                        if (categoryMap[boughtMaterial]?.toLowerCase() === categoryMap[cat]?.toLowerCase()) {
                             return true;
                        }
                    }
                    return false;
                });
            });

            filtered.forEach(addToMap);
            
            function addToMap(center) {
                const marker = L.marker([center.lat, center.lng]).addTo(map);
                markers.push(marker);
                
                marker.on('mouseover', function(e) {
                    const estimates = calculateEstimates(center.lat, center.lng);
                    if (estimates) {
                        const tooltipContent = `
                            <div class="font-bold text-sm text-gray-800">${center.name}</div>
                            <div class="text-xs mt-1 text-gray-700">
                                <div>üìè Road Dist: ~${estimates.dist} km</div>
                                <div class="grid grid-cols-3 gap-1 mt-1 text-center">
                                    <div class="tooltip-stat-box">üö∂ ${estimates.walk} min</div>
                                    <div class="tooltip-stat-box">üö≤ ${estimates.bike} min</div>
                                    <div class="tooltip-stat-box">üöó ${estimates.car} min</div>
                                </div>
                            </div>
                        `;
                        this.bindTooltip(tooltipContent, {
                            className: 'custom-tooltip',
                            direction: 'top',
                            permanent: false,
                            opacity: 1
                        }).openTooltip();
                        showRouteVisuals(center.lat, center.lng);
                    }
                });

                marker.on('mouseout', function() {
                    if (routeLine) {
                        map.removeLayer(routeLine);
                        routeLine = null;
                    }
                });

                const popupContent = `
                    <strong style="color:black; font-size:14px;">${center.name}</strong><br>
                    <span style="color:#555; font-size:12px;">${center.address}</span><br>
                    <button 
                        onclick="openGoogleMaps(${center.lat}, ${center.lng})"
                        style="background-color:#166534; color:white; border:none; padding:5px 10px; border-radius:4px; margin-top:8px; cursor:pointer; width:100%; font-weight:bold;">
                        üìç GET DIRECTIONS
                    </button>
                `;
                marker.bindPopup(popupContent);
            }

            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.2));
            }
        }

        function calculateEstimates(lat, lng) {
            if (!userLocation) return null;
            const distKm = map.distance(userLocation, {lat, lng}) / 1000;
            const roadDist = distKm * ROAD_FACTOR;
            const walkTime = Math.round((roadDist / 5) * 60); 
            const bikeTime = Math.round((roadDist / 15) * 60); 
            const carTime = Math.round((roadDist / 30) * 60); 
            return { dist: roadDist.toFixed(1), walk: walkTime, bike: bikeTime, car: carTime };
        }

        function showRouteVisuals(lat, lng) {
            if (!userLocation || !map) return;
            if (routeLine) map.removeLayer(routeLine);
            routeLine = L.polyline([userLocation, {lat, lng}], {
                color: '#3b82f6', 
                dashArray: '5, 10',
                weight: 3,
                opacity: 0.7
            }).addTo(map);
        }

    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trash Snap - Final Pro Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: sans-serif; }
        .dashboard-panel { background: #1e293b; border: 1px solid #059669; border-radius: 8px; padding: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.5); }
        #map { width: 100%; height: 250px; border-radius: 4px; }
        .gallery-item { position: relative; border: 1px solid #334155; height: 100px; cursor: zoom-in; background: #000; }
        .gallery-item.expanded { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; height: 80vh; cursor: zoom-out; border: 2px solid #34d399; }
        .bounding-box { position: absolute; border: 2px solid #6ee7b7; background: rgba(110, 231, 183, 0.1); z-index: 10; pointer-events: none; }
        .bounding-box.highlight { border-color: #00ff00 !important; background: rgba(0, 255, 0, 0.2) !important; box-shadow: 0 0 15px #00ff00; }
        .bounding-box-label { position: absolute; top: -15px; left: 0; background: #6ee7b7; color: #000; font-size: 8px; font-weight: bold; padding: 1px 3px; border-radius: 2px; }
        .feed-item { padding: 8px; border-bottom: 1px solid #334155; cursor: pointer; font-size: 12px; }
        .feed-item:hover { background: #1e3a8a; }
        .loader { border: 3px solid #1e293b; border-top: 3px solid #34d399; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-3 flex flex-col gap-3">

    <header class="bg-slate-900 p-3 border-b border-green-800 flex justify-between rounded">
        <h1 class="font-bold text-green-400 uppercase">Trash Snap Dashboard</h1>
        <div id="loadingSpinner" class="loader"></div>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-12 gap-3">
        <div class="md:col-span-4 flex flex-col gap-3">
            <div class="dashboard-panel">
                <input type="file" id="fileInput" accept="image/*" multiple class="text-xs" />
                <button onclick="identifyWaste()" class="mt-3 w-full bg-green-700 py-2 rounded font-bold hover:bg-green-600 transition">START SCAN</button>
            </div>
            <div id="aiResponse" class="dashboard-panel h-[400px] overflow-y-auto text-xs"></div>
        </div>

        <div class="md:col-span-8 flex flex-col gap-3">
            <div id="previewContainer" class="dashboard-panel h-[150px] flex gap-2 overflow-x-auto"></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div class="dashboard-panel">
                    <button onclick="locateUser()" class="mb-2 text-[10px] bg-blue-900 px-2 py-1 rounded">üìç Locate Me</button>
                    <div id="map"></div>
                </div>
                <div id="marketplace" class="dashboard-panel h-[320px] overflow-y-auto text-xs"></div>
            </div>
        </div>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script>
        let map, selectedImages = [];
        const centers = [
            { name: "Scrapzone", lat: 12.9250, lng: 77.5938, chat: "https://wa.me/919343221221", prices: { plastic: 22, paper: 14, metal: 45 } },
            { name: "Zolopik", lat: 13.0279, lng: 77.5933, chat: "https://wa.me/918884449985", prices: { plastic: 18, paper: 12, metal: 55 } }
        ];

        window.onload = () => {
            map = L.map('map').setView([12.9716, 77.5946], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            centers.forEach(c => {
                L.marker([c.lat, c.lng]).addTo(map).bindPopup(`<b>${c.name}</b><br><button onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${c.lat},${c.lng}')" style="background:#166534; color:white; padding:2px; font-size:9px; border-radius:3px; margin-top:5px; width:100%;">GET DIRECTIONS</button>`);
            });
        };

        window.locateUser = () => navigator.geolocation.getCurrentPosition(p => map.setView([p.coords.latitude, p.coords.longitude], 14));

        document.getElementById('fileInput').addEventListener('change', function() {
            selectedImages = [];
            const cont = document.getElementById('previewContainer');
            cont.innerHTML = "";
            Array.from(this.files).forEach((f, i) => {
                const reader = new FileReader();
                reader.onload = e => {
                    selectedImages.push({ id: i, base64: e.target.result.split(',')[1], mime: f.type });
                    cont.innerHTML += `<div class="gallery-item" id="wrap-${i}" onclick="this.classList.toggle('expanded')"><img src="${e.target.result}" class="h-full"></div>`;
                };
                reader.readAsDataURL(f);
            });
        });

        async function identifyWaste() {
            if (!selectedImages.length) return;
            document.getElementById('loadingSpinner').style.display = 'block';
            const feed = document.getElementById('aiResponse');
            feed.innerHTML = "Neural Scanning...";

            try {
                const promises = selectedImages.map(async img => {
                    const res = await fetch('http://localhost:5000/scan', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ base64: img.base64, mime: img.mime })
                    });
                    return { id: img.id, items: await res.json() };
                });

                const results = await Promise.all(promises);
                feed.innerHTML = "";
                let cats = new Set();

                results.forEach(res => {
                    const wrap = document.getElementById(`wrap-${res.id}`);
                    res.items.forEach((item, idx) => {
                        cats.add(item.category.toLowerCase());
                        const boxId = `box-${res.id}-${idx}`;
                        if (item.box_2d) {
                            const [ymin, xmin, ymax, xmax] = item.box_2d;
                            const box = document.createElement('div');
                            box.className = 'bounding-box';
                            box.id = boxId;
                            box.style.cssText = `top:${ymin/10}%; left:${xmin/10}%; height:${(ymax-ymin)/10}%; width:${(xmax-xmin)/10}%;`;
                            box.innerHTML = `<div class="bounding-box-label">${item.item}</div>`;
                            wrap.appendChild(box);
                        }
                        feed.innerHTML += `<div class="feed-item" onmouseenter="document.getElementById('${boxId}')?.classList.add('highlight')" onmouseleave="document.getElementById('${boxId}')?.classList.remove('highlight')"><b>${item.item}</b> | ${item.confidence}% | ${item.category}</div>`;
                    });
                });
                updateMarket(Array.from(cats));
            } catch (e) { feed.innerHTML = "Error: Start server.js first."; }
            finally { document.getElementById('loadingSpinner').style.display = 'none'; }
        }

        function updateMarket(cats) {
            const m = document.getElementById('marketplace');
            m.innerHTML = cats.map(cat => `
                <div style="border:1px solid #334155; padding:8px; border-radius:5px; margin-bottom:8px;">
                    <b class="uppercase text-green-400">${cat}</b>
                    ${centers.map(c => `
                        <div class="flex justify-between mt-1">
                            <span>${c.name}: ‚Çπ${c.prices[cat] || 0}</span>
                            <button onclick="window.open('${c.chat}')" style="background:#2563eb; color:white; padding:1px 4px; border-radius:3px; font-size:9px;">CHAT</button>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trash Snap - Smart Waste Detection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    
    <style>
        /* --- DASHBOARD THEME --- */
        body {
            background-color: #0f172a; /* Dark Slate / Navy Background */
            color: #e2e8f0; /* Light Gray Text */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Panel Styling */
        .dashboard-panel {
            background-color: #1e293b; 
            border: 1px solid #059669; 
            border-radius: 0.5rem;
            padding: 0.75rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .panel-header {
            font-size: 0.9rem;
            font-weight: bold;
            color: #34d399; 
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #334155;
            padding-bottom: 0.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        /* Input Styling */
        input[type="file"] {
            background-color: #0f172a;
            color: #94a3b8;
            border: 1px dashed #34d399;
            padding: 0.4rem;
            font-size: 0.8rem;
            border-radius: 0.25rem;
            width: 100%;
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid #1e293b;
            border-top: 3px solid #34d399;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Map Fix */
        #map {
            width: 100%;
            height: 100%;
            min-height: 100%;
            border-radius: 0.25rem;
            z-index: 1; 
        }

        /* --- GALLERY & BOXES --- */
        .gallery-container {
            overflow-y: auto;
            flex-grow: 1;
            padding-right: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-content: flex-start;
        }

        .gallery-item {
            position: relative;
            border: 1px solid #334155;
            border-radius: 0.25rem;
            background-color: #020617;
            transition: all 0.3s ease;
            display: flex; 
            flex-direction: column;
            width: fit-content; 
            height: fit-content; 
        }

        .gallery-item.thumbnail {
            height: 120px; 
            cursor: zoom-in;
            opacity: 1;
        }
        
        .gallery-item.thumbnail img {
            height: 120px; 
            width: auto;   
            display: block; 
        }
        .gallery-item.thumbnail .bounding-box { display: none !important; }

        .gallery-item.dimmed { opacity: 0.3; filter: grayscale(80%); }

        /* Expanded State */
        .gallery-item.expanded {
            position: fixed; 
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            max-width: 85vw; 
            max-height: 85vh;
            width: auto !important;
            height: auto !important;
            border: 2px solid #34d399;
            box-shadow: 0 0 100px rgba(0,0,0,0.9);
            background-color: #020617;
            cursor: zoom-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .gallery-item.expanded img { max-width: 100%; max-height: 85vh; width: auto; height: auto; display: block; object-fit: contain; }

        .img-tag { position: absolute; bottom: 4px; right: 4px; background-color: rgba(0, 0, 0, 0.85); color: #34d399; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px; pointer-events: none; z-index: 25; border: 1px solid #34d399; }

        /* Bounding Boxes */
        .bounding-box { position: absolute; border: 2px solid #6ee7b7; background-color: rgba(110, 231, 183, 0.15); z-index: 10; transition: all 0.2s; cursor: pointer; }
        .bounding-box-label { position: absolute; top: -18px; left: 0; background-color: #6ee7b7; color: #0f172a; font-size: 9px; padding: 1px 3px; font-weight: bold; border-radius: 2px; white-space: nowrap; }

        /* Highlight Interaction */
        .bounding-box.highlight { border-color: #00ff00 !important; background-color: rgba(0, 255, 0, 0.2) !important; z-index: 20; box-shadow: 0 0 10px #00ff00; }
        .bounding-box.highlight .bounding-box-label { background-color: #00ff00; color: black; }
        .faded-box { opacity: 0.1; }

        /* Feed Styles */
        .feed-group { margin-bottom: 0.5rem; border: 1px solid #334155; border-radius: 0.25rem; overflow: hidden; }
        .feed-header { background-color: #1e293b; padding: 0.5rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: #e2e8f0; font-weight: bold; transition: background-color 0.2s; }
        .feed-header:hover { background-color: #334155; }
        .feed-content { display: none; background-color: #0f172a; padding: 0.25rem; }
        .feed-content.open { display: block; }
        .feed-item { padding: 0.4rem; margin: 0.25rem 0; border-left: 2px solid #34d399; background-color: #1e293b; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; }
        .feed-item:hover { background-color: #1e3a8a; padding-left: 0.6rem; }
        .dropdown-arrow { transition: transform 0.2s; font-size: 0.7rem; }
        
        /* Marketplace Styles */
        .price-category-group { border: 1px solid #334155; border-radius: 4px; margin-bottom: 10px; padding: 5px; }
        .price-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px dashed #334155; }
        .best-price { background-color: #047857; color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-slate-900 border-b border-green-800 p-3 flex justify-between items-center shadow-lg z-50 sticky top-0">
        <div class="flex items-center gap-2">
            <span class="text-xl">‚ôªÔ∏è</span>
            <h1 class="text-lg font-bold text-green-400 uppercase">TRASH SNAP <span class="text-[10px] text-gray-500 normal-case ml-2 tracking-widest">Smart Waste Detection & Marketplace</span></h1>
        </div>
    </header>

    <main class="flex-grow p-3 grid grid-cols-1 md:grid-cols-12 gap-3">
        
        <div class="md:col-span-4 flex flex-col gap-3">
            <div class="dashboard-panel">
                <div class="panel-header"><span>1. System Controls</span></div>
                <div class="space-y-3">
                    <input type="file" id="fileInput" accept="image/*" multiple />
                    <button onclick="identifyWaste()" class="w-full bg-green-700 hover:bg-green-600 text-white py-2 rounded font-bold transition flex justify-center items-center gap-2">
                        <span>INITIATE SCAN</span>
                        <div id="loadingSpinner" class="loader"></div>
                    </button>
                </div>
            </div>

            <div class="dashboard-panel flex-grow" style="height: 500px; max-height: 500px;">
                <div class="panel-header"><span>Detected Objects Feed</span></div>
                <div id="aiResponse" class="overflow-y-auto h-full text-xs space-y-2">
                    <div class="text-gray-500 italic text-center mt-10">Upload images to begin analysis.</div>
                </div>
            </div>
        </div>

        <div class="md:col-span-8 flex flex-col gap-3">
            <div class="dashboard-panel" style="height: 450px;">
                <div class="panel-header"><span>2. Visual Analysis Monitor</span></div>
                <div id="previewContainer" class="gallery-container"></div>
            </div>

            <div class="dashboard-panel" style="height: 350px;">
                <div class="panel-header"><span>3. Tracking</span> <button onclick="locateUser()" class="text-[10px] bg-blue-900 px-2 py-0.5 rounded">üìç Locate Me</button></div>
                <div id="map"></div>
            </div>
            
            <div class="dashboard-panel">
                <div class="panel-header"><span>4. Marketplace Pricing</span></div>
                <div id="marketplaceComparison" class="overflow-y-auto text-xs space-y-3"></div>
            </div>
        </div>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script>
        let map, selectedImages = [], markers = [];
        const centers = [
            { name: "Scrapzone", lat: 12.9250, lng: 77.5938, chat: "https://wa.me/919343221221", prices: { plastic: 22, paper: 14, metal: 45 } },
            { name: "Zolopik", lat: 13.0279, lng: 77.5933, chat: "https://wa.me/918884449985", prices: { plastic: 18, paper: 12, metal: 55 } }
        ];
        const categoryMap = { plastic: "Plastic", paper: "Paper", metal: "Metal", "e-waste": "E-Waste" };

        window.onload = () => {
            map = L.map('map').setView([12.9716, 77.5946], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            centers.forEach(c => L.marker([c.lat, c.lng]).addTo(map).bindPopup(`<b>${c.name}</b><br><button onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${c.lat},${c.lng}')" style="background:#166534; color:white; padding:2px 5px; font-size:10px; margin-top:5px; border-radius:3px; width:100%;">DIRECTIONS</button>`));
        };

        window.locateUser = () => navigator.geolocation.getCurrentPosition(p => map.setView([p.coords.latitude, p.coords.longitude], 14));

        document.getElementById('fileInput').onchange = (e) => {
            selectedImages = []; document.getElementById('previewContainer').innerHTML = "";
            Array.from(e.target.files).forEach((f, i) => {
                const reader = new FileReader();
                reader.onload = ev => {
                    selectedImages.push({ id: i, base64: ev.target.result.split(',')[1], mime: f.type });
                    document.getElementById('previewContainer').innerHTML += `<div class="gallery-item thumbnail" id="img-wrapper-${i}" onclick="this.classList.toggle('expanded')"><img src="${ev.target.result}"><div class="img-tag">IMG #${i+1}</div></div>`;
                };
                reader.readAsDataURL(f);
            });
        };

        async function identifyWaste() {
            if (!selectedImages.length) return;
            document.getElementById('loadingSpinner').style.display = 'block';
            const feed = document.getElementById('aiResponse');
            feed.innerHTML = "<div class='text-green-400 animate-pulse text-center mt-10'>[SYSTEM] Neural Processing...</div>";

            try {
                // PARALLEL SCAN LOGIC
                const results = await Promise.all(selectedImages.map(async img => {
                    const res = await fetch('http://localhost:5000/scan', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ base64: img.base64, mime: img.mime })
                    });
                    return { id: img.id, items: await res.json() };
                }));

                feed.innerHTML = ""; let allCats = new Set();
                results.forEach(res => {
                    const wrap = document.getElementById(`img-wrapper-${res.id}`);
                    let itemsHtml = "";
                    res.items.forEach((item, idx) => {
                        allCats.add(item.category.toLowerCase());
                        const boxId = `box-${res.id}-${idx}`;
                        if (item.box_2d) {
                            const [ymin, xmin, ymax, xmax] = item.box_2d;
                            const box = document.createElement('div');
                            box.className = 'bounding-box'; box.id = boxId;
                            box.style.cssText = `top:${ymin/10}%; left:${xmin/10}%; height:${(ymax-ymin)/10}%; width:${(xmax-xmin)/10}%;`;
                            box.innerHTML = `<div class="bounding-box-label">${item.item}</div>`;
                            wrap.appendChild(box);
                        }
                        itemsHtml += `<div class="feed-item" onmouseenter="document.getElementById('${boxId}')?.classList.add('highlight')" onmouseleave="document.getElementById('${boxId}')?.classList.remove('highlight')"><b>${item.item}</b> | ${item.confidence}% | ${item.category}</div>`;
                    });
                    feed.innerHTML += `<div class="feed-group"><div class="feed-header" onclick="this.nextElementSibling.classList.toggle('open')"><span>üì∑ IMG #${res.id+1}</span><span>‚ñº</span></div><div class="feed-content open">${itemsHtml}</div></div>`;
                });
                updateMarket(Array.from(allCats));
            } catch (e) { feed.innerHTML = "Error: Start server.js first."; }
            finally { document.getElementById('loadingSpinner').style.display = 'none'; }
        }

        function updateMarket(cats) {
            const m = document.getElementById('marketplaceComparison');
            m.innerHTML = cats.map(cat => `
                <div class="price-category-group"><b class="uppercase text-green-300 underline">${cat} Rates</b>
                    ${centers.map(c => `<div class="price-row"><span>${c.name}: ‚Çπ${c.prices[cat] || 0}</span><button onclick="window.open('${c.chat}')" class="bg-blue-600 px-2 rounded text-[10px]">CHAT</button></div>`).join('')}
                </div>`).join('');
        }
    </script>
</body>
</html>